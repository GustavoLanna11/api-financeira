openapi: 3.0.3
info:
  title: API Financeira - Internal & Open Finance
  version: 1.1.0
  description: >
    API RESTful com rotas internas e rotas Open Finance alinhadas à API fornecedora.

servers:
  - url: http://localhost:4000
    description: Servidor local

paths:
  /users:
    get:
      summary: Lista usuários
      tags: [Usuários]
      responses:
        200:
          description: Lista de usuários
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      summary: Cria usuário
      tags: [Usuários]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        201:
          description: Usuário criado

  /users/{id}:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Busca usuário por ID
      tags: [Usuários]
      responses:
        200:
          description: Usuário encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        404:
          description: Não encontrado
    put:
      summary: Atualiza usuário
      tags: [Usuários]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        200:
          description: Atualizado
    delete:
      summary: Remove usuário
      tags: [Usuários]
      responses:
        204:
          description: Removido

  /users/{id}/accounts:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Lista contas de um usuário
      tags: [Usuários]
      responses:
        200:
          description: Lista de contas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BankAccount'

  /accounts:
    get:
      summary: Lista contas bancárias
      tags: [Contas]
      responses:
        200:
          description: Lista de contas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BankAccount'
    post:
      summary: Cria conta bancária
      tags: [Contas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BankAccountInput'
      responses:
        201:
          description: Conta criada

  /accounts/{id}:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Busca conta
      tags: [Contas]
      responses:
        200:
          description: Conta encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BankAccount'
        404:
          description: Não encontrada
    put:
      summary: Atualiza conta
      tags: [Contas]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BankAccountInput'
      responses:
        200:
          description: Conta atualizada
    delete:
      summary: Remove conta
      tags: [Contas]
      responses:
        204:
          description: Removida

  /accounts/{id}/transactions:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Lista transações da conta
      tags: [Contas]
      responses:
        200:
          description: Lista de transações
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Transaction'

  /accounts/{id}/balance:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Consulta saldo interno
      tags: [Contas]
      responses:
        200:
          description: Saldo da conta
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                    format: float

  /transactions:
    get:
      summary: Lista transações
      tags: [Transações]
      responses:
        200:
          description: Lista de transações
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Transaction'
    post:
      summary: Cria transação
      tags: [Transações]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionInput'
      responses:
        201:
          description: Criada

  /transactions/{id}:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Busca transação
      tags: [Transações]
      responses:
        200:
          description: Encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
    put:
      summary: Atualiza transação
      tags: [Transações]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionInput'
      responses:
        200:
          description: Atualizada
    delete:
      summary: Remove transação
      tags: [Transações]
      responses:
        204:
          description: Removida

  /openfinance/consents:
    post:
      summary: Cria consentimento (uso interno)
      tags: [Consentimentos Internos]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConsentInput'
      responses:
        201:
          description: Consentimento criado
    get:
      summary: Lista consentimentos ativos
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Lista consentimentos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Consent'

  /openfinance/consents/{id}:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    delete:
      summary: Revoga consentimento (uso interno)
      tags: [Consentimentos Internos]
      responses:
        200:
          description: Consentimento revogado
    get:
      summary: Consulta consentimento
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Consentimento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Consent'
        404:
          description: Não encontrado

  /openfinance/institution:
    get:
      summary: Dados da instituição
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Dados básicos
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  status:
                    type: boolean

  /openfinance/customers/{id}:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Dados do cliente (Open Finance)
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Dados básicos autorizados
          content:
            application/json:
              schema:
                type: object
                properties:
                  _id:
                    type: string
                  name:
                    type: string
                  cpf:
                    type: string

  /openfinance/customers/{id}/accounts:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Contas do cliente (Open Finance)
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Lista filtrada
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    _id:
                      type: string
                    type:
                      type: string
                    branch:
                      type: string
                    number:
                      type: string

  /openfinance/accounts/{id}/balance:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Saldo Open Finance
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Saldo disponível
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                    format: float

  /openfinance/accounts/{id}/transactions:
    parameters:
      - $ref: '#/components/parameters/IdParam'
    get:
      summary: Transações Open Finance
      tags: [Open Finance]
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Lista de transações autorizadas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OpenFinanceTransaction'

components:
  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key

  schemas:
    User:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        cpf:
          type: string
        email:
          type: string
        accounts:
          type: array
          items:
            type: string
    UserInput:
      type: object
      required: [name, cpf, email]
      properties:
        name:
          type: string
        cpf:
          type: string
        email:
          type: string
        accounts:
          type: array
          items:
            type: string
    BankAccount:
      type: object
      properties:
        _id:
          type: string
        type:
          type: string
        branch:
          type: string
        number:
          type: string
        balance:
          type: number
        user:
          type: array
          items:
            type: string
        transactions:
          type: array
          items:
            type: string
    BankAccountInput:
      type: object
      required: [type, branch, number, balance, user]
      properties:
        type:
          type: string
        branch:
          type: string
        number:
          type: string
        balance:
          type: number
        transactions:
          type: array
          items:
            type: string
        user:
          type: array
          items:
            type: string
    Transaction:
      type: object
      properties:
        _id:
          type: string
        date:
          type: string
          format: date-time
        description:
          type: string
        amount:
          type: number
        type:
          type: string
        category:
          type: string
        fromAccount:
          type: array
          items:
            type: string
        toAccount:
          type: array
          items:
            type: string
    TransactionInput:
      type: object
      required: [description, amount, type, category]
      properties:
        date:
          type: string
          format: date-time
        description:
          type: string
        amount:
          type: number
        type:
          type: string
          enum: [credit, debit, transfer]
        category:
          type: string
        fromAccount:
          type: array
          items:
            type: string
        toAccount:
          type: array
          items:
            type: string
    Consent:
      type: object
      properties:
        _id:
          type: string
        customer:
          type: string
        clientAppId:
          type: string
        permissions:
          type: array
          items:
            type: string
            enum: [accounts, transactions]
        status:
          type: string
          enum: [active, revoked, expired]
        expiresAt:
          type: string
          format: date-time
        revokedAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
    ConsentInput:
      type: object
      required: [customerId, permissions, expiresAt]
      properties:
        customerId:
          type: string
        clientAppId:
          type: string
          description: Opcional - usa clientAppId do header se omitido
        permissions:
          type: array
          items:
            type: string
            enum: [accounts, transactions]
        expiresAt:
          type: string
          format: date-time
    OpenFinanceTransaction:
      type: object
      properties:
        _id:
          type: string
        date:
          type: string
          format: date-time
        description:
          type: string
        amount:
          type: number
        type:
          type: string
        category:
          type: string

tags:
  - name: Usuários
    description: Rotas internas de usuários
  - name: Contas
    description: Rotas internas de contas
  - name: Transações
    description: Rotas internas de transações
  - name: Consentimentos Internos
    description: Gestão interna de consentimentos
  - name: Open Finance
    description: Rotas públicas que exigem API Key
